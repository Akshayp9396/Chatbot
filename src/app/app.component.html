<div class="shell" *ngIf="chatOpen">

  <!-- ==== Top Bar ==== -->

  <header class="topbar">
    <div class="brand">
      <!-- <img src="assets/icons/icon.svg" alt="" class="logo" aria-hidden="true" /> -->
      <ng-lottie
        class="logo"
        [options]="brandLottieOpts"
        (animationCreated)="onBrandAnimCreated($event)">
      </ng-lottie>

      <!-- Title + Presence -->
      <div class="titles">
        <div class="title">Chat With Us!</div>
        <div class="online">
          <span class="dot"></span>
          Online
        </div>
      </div>
    </div>

    <!-- Header Actions -->
    <div class="actions">
      <button
        class="icon-btn"
        aria-label="Refresh"
        title="Refresh"
        (click)="onRefresh()">
        <img class="ico" src="assets/icons/refresh.svg" alt="" />
      </button>

      <button
        class="icon-btn"
        aria-label="Close chat"
        title="Close"
        (click)="onClose()">
        <img class="ico" src="assets/icons/Cross.svg" alt="" />
      </button>
    </div>
  </header>

  <!-- =========================
       Messages Canvas
       ========================= -->
  <main class="canvas" #canvas>
    <div class="msgs">
      <ng-container *ngFor="let m of messages">

        <!-- BOT is typing -->
        <div
          class="row"
          *ngIf="m.sender === 'typing'"
          style="display:flex;align-items:center;gap:8px;">
          <div class="avatar talking">
            <ng-lottie
              class="lottie-avatar"
              [options]="botTypingOpts"
              aria-hidden="true">
            </ng-lottie>
          </div>

          <div
            class="bubble bot typing"
            style="background:transparent;border:none;padding:0;box-shadow:none;display:flex;align-items:center;">
            <ng-lottie
              [options]="{ path: 'assets/lottie/user.json', autoplay: true, loop: true, renderer: 'svg' }"
              style="width:104px;height:124px;display:block;line-height:0;"
              aria-hidden="true">
            </ng-lottie>
          </div>
        </div>

        <!-- BOT message: avatar + bubble + timestamp -->
        <div
          class="row"
          *ngIf="m.sender === 'bot'"
          style="display:flex;align-items:center;gap:8px;">
          <div class="avatar">
            <ng-lottie
              class="lottie-avatar"
              [options]="botAvatarOpts"
              aria-hidden="true">
            </ng-lottie>
          </div>

          <div class="stack left">
            <div class="bubble bot">

              <!-- Bot text -->
              <div
                class="msg-text"
                *ngIf="m.text"
                [innerText]="m.text">
              </div>

              <!-- Bot images -->
              <div class="msg-images" *ngIf="m.images?.length">
                <button
                  class="img"
                  type="button"
                  *ngFor="let img of m.images"
                  (click)="openImage(img)"
                  [title]="img.name || 'Image'">
                  <img
                    [src]="img.thumbUrl || img.url"
                    [alt]="img.name || 'Image'" />
                </button>
              </div>

              <!-- Bot docs -->
              <div class="msg-docs" *ngIf="m.docs?.length">
                <a
                  class="doc-card"
                  *ngFor="let d of m.docs"
                  [href]="d.url"
                  target="_blank"
                  rel="noopener"
                  [title]="d.name">
                  <img class="doc-ico" src="assets/icons/doc.svg" alt="" aria-hidden="true" />
                  <span class="doc-title">{{ d.name }}</span>
                  <span class="doc-size" *ngIf="d.sizeKB">¬∑ {{ d.sizeKB }} KB</span>
                </a>
              </div>
            </div>

            <!-- Bot timestamp -->
            <div class="meta-line left">
              {{ m.createdAt | date:'shortTime' }}
            </div>
          </div>
        </div>

        <!-- USER message: bubble + timestamp + tick + avatar -->
        <div
          class="row me"
          *ngIf="m.sender === 'user'"
          style="display:flex;align-items:center;gap:8px;justify-content:flex-end;">
          <div class="stack right">
            <div class="bubble me">

              <!-- User text -->
              <div
                class="msg-text"
                *ngIf="m.text"
                [innerText]="m.text">
              </div>

              <!-- User images -->
              <div
                class="msg-images"
                *ngIf="m.images?.length"
                role="group"
                aria-label="Attached images">
                <button
                  class="img"
                  type="button"
                  *ngFor="let img of m.images"
                  (click)="openImage(img)"
                  [title]="img.name || 'Image'">
                  <img
                    [src]="img.thumbUrl || img.url"
                    [alt]="img.name || 'Image'" />
                </button>
              </div>

              <!-- User docs -->
              <div
                class="msg-docs"
                *ngIf="m.docs?.length"
                role="group"
                aria-label="Attached documents">
                <a
                  class="doc-card"
                  *ngFor="let d of m.docs"
                  [href]="d.url"
                  target="_blank"
                  rel="noopener"
                  [title]="d.name">
                  <img class="doc-ico" src="assets/icons/doc.svg" alt="" aria-hidden="true" />
                  <span class="doc-title">{{ d.name }}</span>
                  <span class="doc-size" *ngIf="d.sizeKB">¬∑ {{ d.sizeKB }} KB</span>
                </a>
              </div>
            </div>

            <!-- User timestamp + tick -->
            <div class="meta-line right">
              {{ m.createdAt | date:'shortTime' }}
              <span class="tick" aria-hidden="true">‚úì</span>
              <!-- <img class="tick-img" src="assets/icons/tick.svg" alt=""> -->
            </div>
          </div>

          <!-- User avatar -->
          <div class="avatar me">
            <img src="assets/icons/user.png" alt="" aria-hidden="true" />
          </div>
        </div>

        <!-- System chip -->
        <div
          class="row"
          *ngIf="m.sender === 'system'"
          style="display:flex;align-items:center;gap:8px;">
          <div class="system" [innerText]="m.text"></div>
        </div>
      </ng-container>

      <!-- USER is typing (outside *ngFor) -->
      <div
        class="row me"
        *ngIf="userTyping"
        style="display:flex;align-items:center;gap:8px;justify-content:flex-end;">
        <div class="stack right">
          <div
            class="bubble me typing"
            style="background:transparent;border:none;padding:0;box-shadow:none;display:flex;align-items:center;gap:6px;">
            <span></span><span></span><span></span>
          </div>
        </div>

        <div class="avatar me talking">
          <img src="assets/icons/user.png" alt="" aria-hidden="true" />
        </div>
      </div>
    </div>
  </main>

  <!-- =========================
       Composer (Bottom)
       ========================= -->
  <footer class="composer-wrap">

    <!-- Quick Replies (first message only) -->
    <div class="quick-row" [class.hidden]="messages.length > 1">
      <button class="chip" (click)="sendQuick('Refund policy')">üí∏ <span>Refund policy</span></button>
      <button class="chip" (click)="sendQuick('Pricing')">üí∞ <span>Pricing</span></button>
      <button class="chip" (click)="sendQuick('FAQs')">üôã‚Äç‚ôÇÔ∏è <span>FAQs</span></button>
    </div>

    <!-- TTS Status -->
    <div class="attach-status" *ngIf="ttsEnabled">
      <div class="pill">
        <img class="pill-ico" src="assets/icons/speaker.svg" alt="" />
        <span>Text ‚Üí Speech enabled</span>
        <button class="pill-x" (click)="disableTTS()" aria-label="Disable TTS">√ó</button>
      </div>
    </div>

    <!-- Attachment Previews (Images + Docs) -->
    <div class="previews" *ngIf="imagePreviews.length || docPreviews.length">

      <!-- Image thumbnails -->
      <div
        class="img-strip"
        *ngIf="imagePreviews.length"
        role="list"
        aria-label="Selected images">
        <div
          class="thumb"
          *ngFor="let p of imagePreviews; let i = index"
          [title]="p.name"
          role="listitem">
          <img [src]="p.url" [alt]="p.name" />
          <button
            class="thumb-x"
            (click)="removeImage(i)"
            aria-label="Remove image">
            √ó
          </button>
        </div>
      </div>

      <!-- Document chips -->
      <div
        class="doc-strip"
        *ngIf="docPreviews.length"
        role="list"
        aria-label="Selected documents">
        <div
          class="doc-chip"
          *ngFor="let d of docPreviews; let i = index"
          [title]="d.name"
          role="listitem">
          <img class="pill-ico" src="assets/icons/doc.svg" alt="" />
          <span class="doc-name">{{ d.name }}</span>
          <span class="doc-size">¬∑ {{ d.sizeKB }} KB</span>
          <button
            class="doc-x"
            (click)="removeDoc(i)"
            aria-label="Remove document">
            √ó
          </button>
        </div>
      </div>
    </div>

    <!-- Composer Grid -->
    <div class="composer">

      <!-- Attach (+) with popover -->
      <div class="attach-anchor">
        <button
          class="circle-btn attach"
          aria-label="Add attachment"
          title="Add attachment"
          (click)="$event.stopPropagation(); toggleAttachMenu()">
          +
        </button>

        <!-- Click-away backdrop -->
        <div
          class="attach-backdrop"
          *ngIf="showAttachMenu"
          (click)="showAttachMenu=false">
        </div>

        <!-- Popover menu -->
        <div
          class="attach-menu"
          *ngIf="showAttachMenu"
          (click)="$event.stopPropagation()">
          <button class="att-item" (click)="pickImages()">
            <img class="att-ico" src="assets/icons/image-.png" alt="" />
            <div class="att-text">
              <div class="att-title">Image (OCR)</div>
              <div class="att-sub">Upload photos; we‚Äôll read the text</div>
            </div>
          </button>

          <button class="att-item" (click)="pickDocs()">
            <img class="att-ico" src="assets/icons/document (1).png" alt="" />
            <div class="att-text">
              <div class="att-title">Add document to text</div>
              <div class="att-sub">PDF, DOCX, TXT‚Ä¶</div>
            </div>
          </button>
        </div>
      </div>

      <!-- Input OR Recording chip -->
      <ng-container *ngIf="!isRecUI; else recordingTpl">
        <input
          type="text"
          [(ngModel)]="text"
          (input)="onUserTyping()"
          (blur)="stopUserTyping(true)"
          (keyup.enter)="send()"
          placeholder="Add a message..."
          aria-label="Message input" />
      </ng-container>

      <!-- Recording UI -->
      <ng-template #recordingTpl>
        <div class="rec-chip" role="group" aria-label="Recording controls">
          <button
            class="rec-btn rec-x"
            (click)="cancelRecording()"
            aria-label="Cancel recording">
            √ó
          </button>

          <div class="rec-body">
            <div class="rec-left">
              <span class="rec-dot" aria-hidden="true"></span>
              <span class="rec-timer">{{ recElapsedLabel }}</span>
            </div>

            <div class="rec-wave" aria-hidden="true">
              <span *ngFor="let _ of waveBars"></span>
            </div>

            <div
              class="rec-text"
              [class.empty]="!interimTranscript && !finalTranscript">
              {{ interimTranscript || finalTranscript || 'Listening‚Ä¶' }}
            </div>
          </div>

          <button
            class="rec-btn rec-ok"
            (click)="confirmRecording()"
            aria-label="Confirm transcription">
            ‚úì
          </button>
        </div>
      </ng-template>

      <!-- Mic + Send (hidden when recording UI visible) -->
      <ng-container *ngIf="!isRecUI">
        <button
          class="circle-btn mic"
          [class.rec]="isRecording"
          (click)="onMicClick()"
          [attr.aria-pressed]="isRecording"
          [title]="isRecording ? 'Stop recording' : 'Record voice'">
          <img src="assets/icons/mic.svg" alt="mic" />
        </button>

        <button
          class="send-btn"
          (click)="send()"
          [disabled]="!text.trim() && !imagePreviews.length && !docPreviews.length"
          title="Send">
          <img src="assets/icons/send.svg" alt="Send" />
        </button>
      </ng-container>

      <!-- Hidden file inputs -->
      <input
        #imgInput
        type="file"
        class="hidden"
        accept="image/*"
        multiple
        (change)="onImagesSelected($event)" />

      <input
        #docInput
        type="file"
        class="hidden"
        accept=".pdf,.doc,.docx,.txt,.md"
        multiple
        (change)="onDocsSelected($event)" />
    </div>
  </footer>
</div>
